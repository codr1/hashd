#!/bin/bash
# =============================================================================
# Pre-commit hook: Secret scanning and basic linting
# =============================================================================
# Install: ln -sf ../../hooks/pre-commit .git/hooks/pre-commit
# =============================================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# =============================================================================
# Get list of staged files
# =============================================================================
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No files staged for commit.${NC}"
    exit 0
fi

FAILED=0

# =============================================================================
# SECRET SCANNING
# =============================================================================
echo ""
echo "=== Secret Scanning ==="

# Patterns that indicate potential secrets
SECRET_PATTERNS=(
    # API Keys
    'AKIA[0-9A-Z]{16}'                          # AWS Access Key
    'sk-[a-zA-Z0-9]{48}'                        # OpenAI API Key
    'sk-ant-[a-zA-Z0-9-]{90,}'                  # Anthropic API Key
    'ghp_[a-zA-Z0-9]{36}'                       # GitHub Personal Access Token
    'gho_[a-zA-Z0-9]{36}'                       # GitHub OAuth Token
    'github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}' # GitHub Fine-grained PAT
    'xox[baprs]-[0-9a-zA-Z-]+'                  # Slack Token

    # Generic patterns
    '[aA][pP][iI][-_]?[kK][eE][yY].*[=:]["'"'"'][a-zA-Z0-9]{16,}["'"'"']'
    '[sS][eE][cC][rR][eE][tT][-_]?[kK][eE][yY].*[=:]["'"'"'][a-zA-Z0-9]{16,}["'"'"']'
    '[pP][aA][sS][sS][wW][oO][rR][dD].*[=:]["'"'"'][^"'"'"']{8,}["'"'"']'
    '[tT][oO][kK][eE][nN].*[=:]["'"'"'][a-zA-Z0-9]{20,}["'"'"']'

    # Private keys
    '-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
    '-----BEGIN PGP PRIVATE KEY BLOCK-----'
)

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -qE "$pattern" "$file" 2>/dev/null; then
                echo -e "${RED}POTENTIAL SECRET DETECTED in $file${NC}"
                echo -e "${RED}Pattern: $pattern${NC}"
                grep -nE "$pattern" "$file" 2>/dev/null | head -3
                FAILED=1
            fi
        done
    fi
done

# Check for files that should never be committed
FORBIDDEN_FILES=(
    '.env'
    '.env.local'
    '.env.production'
    'credentials.json'
    'secrets.json'
    'id_rsa'
    'id_dsa'
    'id_ecdsa'
    'id_ed25519'
    '*.pem'
    '*.key'
)

for file in $STAGED_FILES; do
    filename=$(basename "$file")
    for forbidden in "${FORBIDDEN_FILES[@]}"; do
        if [[ "$filename" == $forbidden ]]; then
            echo -e "${RED}FORBIDDEN FILE: $file${NC}"
            echo -e "${RED}This file type should never be committed.${NC}"
            FAILED=1
        fi
    done
done

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}No secrets detected.${NC}"
fi

# =============================================================================
# PYTHON LINTING
# =============================================================================
echo ""
echo "=== Python Linting ==="

PYTHON_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    # Check for syntax errors
    for file in $PYTHON_FILES; do
        if [ -f "$file" ]; then
            if ! python3 -m py_compile "$file" 2>/dev/null; then
                echo -e "${RED}SYNTAX ERROR in $file${NC}"
                python3 -m py_compile "$file" 2>&1
                FAILED=1
            fi
        fi
    done

    # Check for common issues
    for file in $PYTHON_FILES; do
        if [ -f "$file" ]; then
            # Check for print statements (should use logging)
            if grep -nE '^\s*print\(' "$file" | grep -v '#.*noqa' >/dev/null 2>&1; then
                echo -e "${YELLOW}WARNING: print() statements in $file (consider using logging)${NC}"
                grep -nE '^\s*print\(' "$file" | grep -v '#.*noqa' | head -5
            fi

            # Check for bare except
            if grep -nE '^\s*except\s*:' "$file" >/dev/null 2>&1; then
                echo -e "${YELLOW}WARNING: Bare 'except:' in $file (specify exception type)${NC}"
                grep -nE '^\s*except\s*:' "$file" | head -3
            fi

            # Check for TODO/FIXME
            if grep -niE '\b(TODO|FIXME|XXX|HACK)\b' "$file" >/dev/null 2>&1; then
                echo -e "${YELLOW}NOTE: TODO/FIXME found in $file${NC}"
                grep -niE '\b(TODO|FIXME|XXX|HACK)\b' "$file" | head -3
            fi
        fi
    done

    # Run ruff if available
    if command -v ruff &> /dev/null; then
        echo "Running ruff..."
        if ! ruff check $PYTHON_FILES --quiet; then
            echo -e "${YELLOW}Ruff found issues (run 'ruff check --fix' to auto-fix)${NC}"
            # Don't fail on ruff issues, just warn
        fi
    fi

    # Run mypy if available (type checking)
    if command -v mypy &> /dev/null; then
        echo "Running mypy..."
        mypy $PYTHON_FILES --ignore-missing-imports --no-error-summary 2>/dev/null || true
    fi

    echo -e "${GREEN}Python linting complete.${NC}"
else
    echo "No Python files staged."
fi

# =============================================================================
# FILE SIZE CHECK
# =============================================================================
echo ""
echo "=== File Size Check ==="

MAX_SIZE=$((1024 * 1024))  # 1MB

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt "$MAX_SIZE" ]; then
            echo -e "${RED}LARGE FILE: $file ($(numfmt --to=iec $size))${NC}"
            echo -e "${RED}Files larger than 1MB should not be committed.${NC}"
            FAILED=1
        fi
    fi
done

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All file sizes OK.${NC}"
fi

# =============================================================================
# FINAL RESULT
# =============================================================================
echo ""
echo "=== Pre-commit Check Complete ==="

if [ $FAILED -ne 0 ]; then
    echo -e "${RED}Pre-commit checks FAILED. Commit aborted.${NC}"
    echo -e "${YELLOW}To bypass (NOT RECOMMENDED): git commit --no-verify${NC}"
    exit 1
fi

echo -e "${GREEN}All checks passed!${NC}"
exit 0
